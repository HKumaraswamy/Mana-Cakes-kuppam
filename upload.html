<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Upload Product | Mana Cakes Kuppam</title>
<style>
  body{font-family:Poppins,Segoe UI,Roboto,Arial;background:#fff5f7;margin:0;padding:20px}
  .wrap{max-width:760px;margin:20px auto;background:#fff;border-radius:12px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
  h1{color:#ff4d6d;margin-top:0}
  label{display:block;margin:12px 0 6px;font-weight:600}
  input[type=text],input[type=number]{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd}
  input[type=file]{padding:8px}
  img.preview{width:180px;height:140px;border-radius:10px;object-fit:cover;border:1px solid #eee;margin-top:6px}
  button{background:#ff4d6d;color:#fff;border:none;padding:10px 16px;border-radius:10px;cursor:pointer;font-weight:700}
  .danger{background:#ccc;color:#333}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .muted{color:#666;font-size:13px}
  table{width:100%;border-collapse:collapse;margin-top:20px}
  td,th{border:1px solid #eee;padding:8px;text-align:left}
  th{background:#fff0f3}
  td img{width:70px;height:60px;object-fit:cover;border-radius:6px}
  .actions button{margin-right:6px;padding:4px 8px;font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>üç∞ Manage Cakes</h1>
      <button id="logoutBtn" class="danger">Logout</button>
    </div>

    <div id="not-auth" style="display:none;color:#b33;margin-bottom:12px">
      You are not authorized. <a href="admin.html">Login again</a>.
    </div>

    <div id="form-area">
      <label>Product Name</label>
      <input id="name" type="text" placeholder="Chocolate Truffle">
      <label>Price (‚Çπ)</label>
      <input id="price" type="number" placeholder="350">
      <label>Image</label>
      <input id="imageFile" type="file" accept="image/*">
      <img id="imgPreview" class="preview" style="display:none">
      <div style="margin-top:16px;display:flex;gap:10px">
        <button id="uploadBtn">Upload Product</button>
        <button id="clearBtn" class="danger">Clear</button>
      </div>
      <div id="status" class="muted" style="margin-top:12px"></div>
    </div>

    <table id="productTable">
      <thead><tr><th>Image</th><th>Name</th><th>Price</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

  // ---- Firebase Config ----
  const firebaseConfig = {
    apiKey: "AIzaSyCG6vkAeA0efSZ0ANW7e4qcQkiSOe2583g",
    authDomain: "bakery-data-610dc.firebaseapp.com",
    projectId: "bakery-data-610dc",
    storageBucket: "bakery-data-610dc.firebasestorage.app",
    messagingSenderId: "373918020823",
    appId: "1:373918020823:web:d0c1a902de7fa4f4252c92",
    measurementId: "G-H4JT872JGR"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // ---- Admin session check ----
  if(sessionStorage.getItem("mana_admin")!=="1"){
    document.getElementById("form-area").style.display="none";
    document.getElementById("not-auth").style.display="block";
  }

  document.getElementById("logoutBtn").onclick=()=>{
    sessionStorage.removeItem("mana_admin");
    window.location.href="admin.html";
  };

  // ---- Upload product ----
  const imgFile=document.getElementById("imageFile");
  const imgPreview=document.getElementById("imgPreview");
  const status=document.getElementById("status");

  imgFile.onchange=()=>{
    const f=imgFile.files[0];
    if(!f)return;
    if(f.size>5*1024*1024){alert("File too large! Max 5MB.");imgFile.value="";return;}
    imgPreview.src=URL.createObjectURL(f);
    imgPreview.style.display="block";
  };

  document.getElementById("clearBtn").onclick=()=>{
    document.getElementById("name").value="";
    document.getElementById("price").value="";
    imgFile.value="";
    imgPreview.style.display="none";
    status.textContent="";
  };

  async function refreshProducts(){
    const tbody=document.querySelector("#productTable tbody");
    tbody.innerHTML="";
    const snap=await getDocs(collection(db,"products"));
    snap.forEach(d=>{
      const p=d.data();
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td><img src="${p.imageUrl}"></td>
        <td>${p.name}</td>
        <td>‚Çπ${p.price}</td>
        <td class="actions">
          <button class="editBtn" data-id="${d.id}">Edit</button>
          <button class="delBtn" data-id="${d.id}">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });

    document.querySelectorAll(".delBtn").forEach(btn=>{
      btn.onclick=async()=>{
        if(confirm("Delete this product?")){
          await deleteDoc(doc(db,"products",btn.dataset.id));
          refreshProducts();
        }
      };
    });

    document.querySelectorAll(".editBtn").forEach(btn=>{
      btn.onclick=async()=>{
        const newPrice=prompt("Enter new price:");
        if(!newPrice)return;
        await updateDoc(doc(db,"products",btn.dataset.id),{price:Number(newPrice)});
        refreshProducts();
      };
    });
  }

  refreshProducts();

  document.getElementById("uploadBtn").onclick=async()=>{
    const name=document.getElementById("name").value.trim();
    const price=document.getElementById("price").value.trim();
    const file=imgFile.files[0];
    if(!name||!price||!file){alert("Fill all fields!");return;}

    status.textContent="Uploading image...";
    try{
      const refPath=ref(storage,`products/${Date.now()}_${file.name}`);
      await uploadBytes(refPath,file);
      const url=await getDownloadURL(refPath);
      await addDoc(collection(db,"products"),{name,price:Number(price),imageUrl:url});
      status.textContent="‚úÖ Product uploaded!";
      refreshProducts();
    }catch(err){
      alert("Upload failed: "+err.message);
      status.textContent="Upload failed.";
    }
  };
</script>
</body>
</html>

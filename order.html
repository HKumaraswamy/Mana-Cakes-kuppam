<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Order - Mana Cakes Kuppam</title>
  <style>
    body { font-family: Arial, sans-serif; padding:20px; }
    h2 { color:#ff4081; }
    #map { height:300px; width:100%; margin-top:20px; border-radius:8px; }
    .order-box { border:1px solid #ddd; padding:15px; border-radius:8px; margin-bottom:20px; }
    .order-item { margin-bottom:8px; }
    .total { font-weight:bold; margin-top:12px; }
    .form-group { margin-top:12px; }
    label { display:block; margin-bottom:5px; font-weight:bold; }
    input, select { width:100%; padding:8px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px; }
    .btn-confirm {
      background:#25d366; 
      color:white; 
      padding:12px 20px; 
      border:none; 
      border-radius:8px; 
      cursor:pointer; 
      font-size:16px;
      display:block;
      margin-top:20px;
      text-align:center;
    }
    .btn-confirm:hover { background:#1ebd5a; }
    .note { color:red; font-size:14px; }
  </style>
</head>
<body>

<h2>üõí Your Order</h2>
<div class="order-box" id="orderDetails"></div>

<h2>üë§ Customer Details</h2>
<div class="order-box">
  <div class="form-group">
    <label for="custName">Name:</label>
    <input type="text" id="custName" placeholder="Enter your name" required>
  </div>
  <div class="form-group">
    <label for="custPhone">Phone Number:</label>
    <input type="tel" id="custPhone" placeholder="Enter your phone number" required>
  </div>
  <div class="form-group">
    <label>Payment Method:</label>
    <input type="radio" name="payment" value="UPI" checked> UPI (Full Payment)<br>
    <input type="radio" name="payment" value="COD"> Cash on Delivery (‚Çπ150 advance required)
    <p class="note">‚ö†Ô∏è COD requires ‚Çπ150 advance before delivery.</p>
  </div>
</div>

<h2>üìç Delivery Location</h2>
<div id="map"></div>
<div class="order-box">
  <div id="deliveryCharge">Calculating delivery charge...</div>
</div>

<button class="btn-confirm" onclick="confirmOrder()">‚úÖ Confirm Order via WhatsApp</button>

<script>
function getQueryParam(name){
  let urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(name);
}

// Parse data
let data = JSON.parse(decodeURIComponent(getQueryParam("data")));
let items = data.items;
let location = data.location;

// Show order items
let detailsDiv = document.getElementById("orderDetails");
let total = 0;
let orderText = "üõí Order Details:\n";
items.forEach(item=>{
  detailsDiv.innerHTML += `<div class="order-item">üç∞ ${item.name} x${item.qty} = ‚Çπ${item.price * item.qty}</div>`;
  orderText += `üç∞ ${item.name} x${item.qty} = ‚Çπ${item.price * item.qty}\n`;
  total += item.price * item.qty;
});
detailsDiv.innerHTML += `<div class="total">Subtotal: ‚Çπ${total}</div>`;
orderText += `\nüí∞ Subtotal = ‚Çπ${total}\n`;

// Delivery calculation
let deliveryCharge = 0;
function calculateDeliveryCharge(){
  // Bakery location (Mana Cakes Kuppam)
  let bakery = { lat: 12.7480, lng: 78.3430 }; 

  let service = new google.maps.DistanceMatrixService();
  service.getDistanceMatrix(
    {
      origins: [bakery],
      destinations: [{lat: location.lat, lng: location.lon}],
      travelMode: 'DRIVING'
    },
    function(response, status){
      if(status === "OK"){
        let distanceText = response.rows[0].elements[0].distance.text;
        let distanceKm = parseFloat(distanceText);
        deliveryCharge = Math.ceil(distanceKm * 10); // ‚Çπ10 per km
        document.getElementById("deliveryCharge").innerHTML = `üöö Delivery Charge: ‚Çπ${deliveryCharge} (${distanceText})`;
      } else {
        document.getElementById("deliveryCharge").innerHTML = "‚ö†Ô∏è Unable to calculate delivery charge.";
      }
    }
  );
}
  
// Confirm Order via WhatsApp
function confirmOrder(){
  let name = document.getElementById("custName").value.trim();
  let phone = document.getElementById("custPhone").value.trim();
  let payment = document.querySelector('input[name="payment"]:checked').value;

  if(!name || !phone){
    alert("‚ö†Ô∏è Please enter your name and phone number to confirm order.");
    return;
  }

  let finalTotal = total + deliveryCharge;
  let advanceNote = "";
  if(payment === "COD"){
    advanceNote = "‚ö†Ô∏è COD requires ‚Çπ150 advance.\n";
  }

  let mapsLink = `https://www.google.com/maps?q=${location.lat},${location.lon}`;
  let msg = `üë§ Customer: ${name}\nüìû Phone: ${phone}\nüí≥ Payment: ${payment}\n\n${orderText}üöö Delivery Charge = ‚Çπ${deliveryCharge}\nüí∞ Final Total = ‚Çπ${finalTotal}\n${advanceNote}\nüìç Delivery Location:\n${mapsLink}`;
  
  let whatsappURL = `https://wa.me/919441269096?text=${encodeURIComponent(msg)}`;
  window.open(whatsappURL, "_blank");
}

// Google Maps
function initMap(){
  let userLoc = { lat: location.lat, lng: location.lon };
  let map = new google.maps.Map(document.getElementById("map"), {
    zoom: 15,
    center: userLoc
  });
  new google.maps.Marker({
    position: userLoc,
    map: map,
    title: "Delivery Location"
  });
  calculateDeliveryCharge();
}
</script>

<!-- Google Maps API -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap"></script>

</body>
</html>
